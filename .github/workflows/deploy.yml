name: D√©ploiement VPS

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'app.py'
      - 'components/**'
      - 'models/**'
      - 'utils/**'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - 'assets/**'
  workflow_dispatch:  # Permet de d√©clencher manuellement depuis GitHub

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• R√©cup√©rer le code
        uses: actions/checkout@v4

      - name: üîê D√©ploiement sur VPS via SSH (rapide)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            echo "üöÄ D√©but du d√©ploiement..."
            
            # Aller dans le r√©pertoire de l'application
            cd /var/www/dash-covariate-study
            
            # Afficher le statut git actuel
            echo "üìä Statut Git:"
            git status
            
            # Sauvegarder les changements locaux non commit√©s (optionnel)
            git stash || true
            
            # R√©cup√©rer les derni√®res modifications
            echo "‚¨áÔ∏è R√©cup√©ration des changements..."
            git fetch origin
            
            # Pull la branche principale
            git pull origin main || git pull origin master
            
            # Afficher le dernier commit d√©ploy√©
            echo "‚úÖ Dernier commit d√©ploy√©:"
            git log -1 --oneline
            
            # V√©rifier que docker-compose est disponible
            if ! command -v docker-compose &> /dev/null && ! command -v docker &> /dev/null; then
              echo "‚ùå Docker/Docker Compose non install√©"
              exit 1
            fi
            
            # Utiliser docker compose (nouvelle syntaxe) ou docker-compose (ancienne)
            DOCKER_COMPOSE_CMD="docker compose"
            if ! $DOCKER_COMPOSE_CMD version &> /dev/null; then
              DOCKER_COMPOSE_CMD="docker-compose"
            fi

            echo "üê≥ Reconstruction only-if-needed et red√©marrage sans interruption..."

            # Activer BuildKit pour des builds plus rapides avec cache
            export DOCKER_BUILDKIT=1
            export COMPOSE_DOCKER_CLI_BUILD=1

            # Up avec build conditionnel (recr√©e uniquement si n√©cessaire)
            $DOCKER_COMPOSE_CMD up -d --build --remove-orphans
            
            # V√©rifier que les conteneurs sont en cours d'ex√©cution
            echo "üì¶ Statut des conteneurs:"
            $DOCKER_COMPOSE_CMD ps
            
            # Afficher un court extrait des logs (optionnel)
            echo "üìã Derniers logs (20 lignes):"
            $DOCKER_COMPOSE_CMD logs --tail=20 || true
            
            echo "‚úÖ D√©ploiement termin√© avec succ√®s!"

      - name: ‚úÖ V√©rification post-d√©ploiement
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd /var/www/dash-covariate-study
            
            DOCKER_COMPOSE_CMD="docker compose"
            if ! $DOCKER_COMPOSE_CMD version &> /dev/null; then
              DOCKER_COMPOSE_CMD="docker-compose"
            fi
            
            # V√©rifier que le conteneur est bien en cours d'ex√©cution
            if $DOCKER_COMPOSE_CMD ps | grep -q "Up"; then
              echo "‚úÖ Application d√©ploy√©e et en cours d'ex√©cution"
            else
              echo "‚ö†Ô∏è Attention: Le conteneur pourrait ne pas √™tre en cours d'ex√©cution"
              exit 1
            fi

