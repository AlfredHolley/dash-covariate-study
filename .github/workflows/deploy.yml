name: D√©ploiement VPS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Permet de d√©clencher manuellement depuis GitHub

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• R√©cup√©rer le code
        uses: actions/checkout@v4

      - name: üß™ Tests pr√©-d√©ploiement (optionnel)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          python -m py_compile app.py
          echo "‚úÖ Tests de syntaxe r√©ussis"

      - name: üîê D√©ploiement sur VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            echo "üöÄ D√©but du d√©ploiement..."
            
            # Aller dans le r√©pertoire de l'application
            cd /var/www/dash-covariate-study
            
            # Afficher le statut git actuel
            echo "üìä Statut Git:"
            git status
            
            # Sauvegarder les changements locaux non commit√©s (optionnel)
            git stash || true
            
            # R√©cup√©rer les derni√®res modifications
            echo "‚¨áÔ∏è R√©cup√©ration des changements..."
            git fetch origin
            
            # Pull la branche principale
            git pull origin main || git pull origin master
            
            # Afficher le dernier commit d√©ploy√©
            echo "‚úÖ Dernier commit d√©ploy√©:"
            git log -1 --oneline
            
            # V√©rifier que docker-compose est disponible
            if ! command -v docker-compose &> /dev/null && ! command -v docker &> /dev/null; then
              echo "‚ùå Docker/Docker Compose non install√©"
              exit 1
            fi
            
            # Utiliser docker compose (nouvelle syntaxe) ou docker-compose (ancienne)
            DOCKER_COMPOSE_CMD="docker compose"
            if ! $DOCKER_COMPOSE_CMD version &> /dev/null; then
              DOCKER_COMPOSE_CMD="docker-compose"
            fi
            
            echo "üê≥ Reconstruction et red√©marrage des conteneurs..."
            
            # Arr√™ter les conteneurs existants
            $DOCKER_COMPOSE_CMD down || true
            
            # Rebuild les images (sans cache pour garantir la derni√®re version)
            $DOCKER_COMPOSE_CMD build --no-cache
            
            # D√©marrer les conteneurs
            $DOCKER_COMPOSE_CMD up -d
            
            # Attendre un peu pour que les conteneurs d√©marrent
            sleep 5
            
            # V√©rifier que les conteneurs sont en cours d'ex√©cution
            echo "üì¶ Statut des conteneurs:"
            $DOCKER_COMPOSE_CMD ps
            
            # Afficher les derni√®res lignes des logs
            echo "üìã Derniers logs:"
            $DOCKER_COMPOSE_CMD logs --tail=50
            
            echo "‚úÖ D√©ploiement termin√© avec succ√®s!"

      - name: ‚úÖ V√©rification post-d√©ploiement
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd /var/www/dash-covariate-study
            
            DOCKER_COMPOSE_CMD="docker compose"
            if ! $DOCKER_COMPOSE_CMD version &> /dev/null; then
              DOCKER_COMPOSE_CMD="docker-compose"
            fi
            
            # V√©rifier que le conteneur est bien en cours d'ex√©cution
            if $DOCKER_COMPOSE_CMD ps | grep -q "Up"; then
              echo "‚úÖ Application d√©ploy√©e et en cours d'ex√©cution"
            else
              echo "‚ö†Ô∏è Attention: Le conteneur pourrait ne pas √™tre en cours d'ex√©cution"
              exit 1
            fi

